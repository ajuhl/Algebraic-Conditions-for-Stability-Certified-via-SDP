% Initialize Variables
A=[sym('421050745442291/1000000000000000'),  0,0,0,0,0,0,0,0,0,0,0,0
  -sym('761079419591268/10000000000000000'), sym('264353986580857/1000000000000000'),  0,0,0,0,0,0,0,0,0,0,0
   sym('727106904170694/10000000000000000'),-sym('204265976977285/1000000000000000'),  sym('181608196544136/1000000000000000'),  0,0,0,0,0,0,0,0,0,0
   sym('557630548166110/1000000000000000'), -sym('409773579543499/1000000000000000'),  sym('510926516886944/1000000000000000'), sym('259892204518476/1000000000000000'),   0,0,0,0,0,0,0,0,0
   sym('228083864844437/10000000000000000'),-sym('445569051836454/1000000000000000'), -sym('915242778636248/10000000000000000'),sym('450055909321655/100000000000000000'), sym('639780719998300/1000000000000000'),   0,0,0,0,0,0,0,0
  -sym('135945849505152/1000000000000000'),  sym('946509646963754/10000000000000000'),-sym('236110197279175/1000000000000000'), sym('318944206456517/100000000000000000'), sym('255453021028118/1000000000000000'),   sym('174805219173446/1000000000000000'), 0,0,0,0,0,0,0
  -sym('147960260670772/1000000000000000'), -sym('402188192230535/1000000000000000'), -sym('703014530043888/1000000000000000'), sym('941974677418186/100000000000000000'), sym('885747111289207/1000000000000000'),   sym('261314066449028/1000000000000000'), sym('163076975036680/1000000000000000'),  0,0,0,0,0,0
   sym('165597241042244/1000000000000000'),  sym('824182962188923/1000000000000000'), -sym('280136160783609/10000000000000000'),sym('282372386631758/1000000000000000'),  -sym('957721354131182/1000000000000000'),   sym('489439550159977/1000000000000000'), sym('170094415598103/1000000000000000'),  sym('522519785718563/10000000000000000'), 0,0,0,0,0
   sym('335292011495618/10000000000000000'), sym('575750388029166/1000000000000000'),  sym('223289855356637/1000000000000000'),-sym('317458833242804/100000000000000000'),-sym('112890382135193/1000000000000000'),  -sym('419809267954284/1000000000000000'), sym('466136902102104/10000000000000000'),-sym('115413813041085/100000000000000000'),sym('109685363692383/1000000000000000'), 0,0,0,0
  -sym('512616878252355/10000000000000000'), sym('699261265830807/1000000000000000'), -sym('117939611738769/1000000000000000'), sym('217452419312430/100000000000000000'),-sym('932826702640947/100000000000000000'),-sym('267575057469428/1000000000000000'), sym('126949139814065/1000000000000000'),  sym('330353204502163/100000000000000000'),sym('185949445053766/1000000000000000'), sym('938215615963721/10000000000000000'), 0,0,0
  -sym('106521517960343/1000000000000000'),  sym('418358890961680/1000000000000000'),  sym('353585905881916/1000000000000000'),-sym('746474161579599/10000000000000000'), -sym('154506264602890/10000000000000000'), -sym('462246591922750/1000000000000000'),-sym('576406327329181/10000000000000000'),-sym('712066942504018/100000000000000000'),sym('377776558014452/1000000000000000'), sym('368900543382940/1000000000000000'),  sym('618488746331837/10000000000000000'),0,0
  -sym('163079104890997/1000000000000000'),  sym('644561721693806/1000000000000000'),  sym('636968661639572/1000000000000000'),-sym('122346720085377/1000000000000000'),  -sym('333062564990312/1000000000000000'),  -sym('305422649047800/1000000000000000'),-sym('357820712828352/1000000000000000'), -sym('125510510334706/10000000000000000'), sym('371263681186311/1000000000000000'), sym('371979640363694/1000000000000000'),  sym('531090658708968/10000000000000000'),sym('518279459132049/10000000000000000'),0
   sym('579993784455521/1000000000000000'), -sym('188833728676494/1000000000000000'),  sym('999975696843775/1000000000000000'), sym('572810855901161/10000000000000000'), -sym('264374735003671/1000000000000000'),   sym('165091739976854/1000000000000000'),-sym('546675809010452/1000000000000000'), -sym('283821822291982/10000000000000000'),-sym('102639860418374/1000000000000000'),-sym('343251040446405/10000000000000000'), sym('476259846259100/1000000000000000'),-sym('304153104931261/1000000000000000'), sym('953911855943621/10000000000000000')];
b=[0
 sym('516650324205117/1000000000000000')
 sym('773227217357826/10000000000000000')
-sym('124742046669750/1000000000000000')
-sym('241052115180679/10000000000000000')
-sym('325821145180359/1000000000000000')
 sym('907237460123951/10000000000000000')
 sym('459271880596652/10000000000000000')
 sym('221012259404702/1000000000000000')
 sym('235510906761942/1000000000000000')
 sym('491109674204385/1000000000000000')
-sym('323506525837343/1000000000000000')
 sym('119918108821531/1000000000000000')];
s = length(A);  p = 8;  % number of stages & order of method
e = ones(s,1);  I = eye(s);
M = e;
for i = 1:s-1
    M = [M A^i*e];
end

disp('Check tall tree conditions')
fact = sym(factorial((1:p)'));
fact_recip = 1./fact;
disp(logical(M(:,1:p)'*b == fact_recip)')

%% Strategy 1
syms z
syms y real
% Determine N and D functions
[N(z),D(z)] = numden(1 + z*b'*(I - z*A)^(-1)*e);

% Create E-poly
E(y) = collect(expand(D(1i*y)*D(-1i*y) - N(1i*y)*N(-1i*y)));

disp('Check sign of E-polynomial coefficients')
k = coeffs(E(y));
disp(logical(k >= 0))

% Standardize E-polynomial
kend = k(end);
P = diag(k./kend);
Pd = double(P);
m = length(Pd);
dof = nchoosek(m-1,2);

% Create monomial vector
ys = 1;
for i = 1:m-1
    ys = [ys;y^i];
end

% Define N such that y'Ny==0
n = triu(sym('n',[m m],'real'));
N = sym(zeros(m,m));
Im = eye(m);
for i = 1:m-2
    for j = i+2:m
        % l = m*(i-1) - .5*i*(i+3) + j
        c = ceil((i+j)/2);
        f = floor((i+j)/2);
        N = N + n(i,j)*(Im(:,i)*Im(:,j)' + Im(:,j)*Im(:,i)' - Im(:,f)*Im(:,c)' - Im(:,c)*Im(:,f)');
    end
end

% Create symbolic function for N
inputs = sort(n(triu(n,2) ~= 0));
Ns = symfun(N,inputs);

% Create double precision function for N
Nd = matlabFunction(N);

% E-poly SDP
cvx_precision high
cvx_begin sdp quiet
    variable gam
    variable eta(dof,1)
    minimize 1
    subject to
        in = num2cell(eta);
        (Pd+Nd(in{:}))*1e-10 >= 0;
cvx_end

% Symbolic LDL factorization of F
etaF = sym(round(eta,-2))'
in = sym2cell(etaF);
F = P + Ns(in{:})
[LF,DF] = ldls(F)

%% Verify LDL factoriztion
% all(all(logical(F == LF*DF*LF')))

% Verify A-stability conditions
% logical(expand(E(y) - kend*y^2*ys'*F*ys) == 0)
% all(logical(diag(DF) >= 0))

%% Clear Misc. Vars
clearvars -except etaF F LF DF

%% Symbolic LDL factorization
function [L,D] = ldls(M)

    % Initialize L and D
    l = length(M);
    L = sym(eye(l));
    D = sym(zeros(l));
    
    % LDL^T decomposition
    for j = 1:l
        % Diagonal D entries
        sumD = 0;
        for k = 1:j-1
            sumD = sumD + L(j,k)^2*D(k,k);
        end
        D(j,j) = M(j,j) - sumD;
        
        % Off-diagonal L entries
        for i = j+1:l
            sumL = 0;
            for k = 1:j-1
                sumL = sumL + L(i,k)*L(j,k)*D(k,k);
            end
            if(D(j,j) ~= 0)
                L(i,j) = (M(i,j) - sumL)/D(j,j);
            end
        end
    end
end
